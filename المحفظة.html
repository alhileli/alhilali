<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مستعرض محفظة MEXC (نسخة مكتفية ذاتياً)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        .card { background-color: #161b22; border: 1px solid #30363d; border-radius: 8px; }
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .loader { border: 4px solid #30363d; border-top: 4px solid #388bfd; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #21262d; color: #c9d1d9; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; font-size: 12px; border: 1px solid #30363d; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto space-y-8">
        
        <header class="text-center space-y-2">
            <h1 class="text-3xl md:text-4xl font-bold text-white">لوحة عرض أداء المحفظة (MEXC)</h1>
            <p class="text-gray-400">عرض شفاف ومباشر لأداء الصفقات من حسابك.</p>
        </header>

        <div id="api-section" class="card p-6 space-y-4">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold text-white">إعدادات الربط</h2>
                 <div class="tooltip">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-info-circle text-gray-400" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-2.29-.287a.5.5 0 0 1-.497-.568l.738-3.468a.5.5 0 0 1 .497-.469zM8 4.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>
                    <span class="tooltiptext">يجب إنشاء مفاتيح API جديدة من MEXC مع صلاحية "القراءة فقط". لا تشارك هذه المفاتيح مع أحد. يتم حفظها في متصفحك فقط.</span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="apiKey" placeholder="Access Key" class="bg-gray-900 border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                <input type="password" id="secretKey" placeholder="Secret Key" class="bg-gray-900 border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                <button id="connect-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                    ربط وعرض البيانات
                </button>
            </div>
             <p id="error-message" class="text-red-400 bg-red-900/20 border border-red-500/30 rounded-md p-3 text-sm mt-4 hidden"></p>
        </div>

        <div id="dashboard-section" class="hidden space-y-8">
            <div class="flex justify-between items-start">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full">
                    <div class="card p-6 flex flex-col justify-center items-center"><h3 class="text-gray-400 text-lg">إجمالي قيمة المحفظة (USDT)</h3><p id="total-balance" class="text-3xl font-bold text-white mt-2">--.--</p></div>
                    <div class="card p-6 flex flex-col justify-center items-center"><h3 class="text-gray-400 text-lg">قيمة الأصول (USDT)</h3><p id="assets-value" class="text-3xl font-bold text-white mt-2">--.--</p></div>
                    <div class="card p-6 flex flex-col justify-center items-center"><h3 class="text-gray-400 text-lg">عدد الأصول</h3><p id="assets-count" class="text-3xl font-bold mt-2">--</p></div>
                </div>
                <button id="disconnect-btn" class="mr-6 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors flex-shrink-0">قطع الاتصال</button>
            </div>

            <div>
                <h2 class="text-2xl font-bold text-white mb-4">الأصول في المحفظة</h2>
                <div class="card overflow-x-auto">
                    <table class="w-full text-right"><thead class="bg-gray-800 text-gray-300"><tr><th class="p-4">الأصل</th><th class="p-4">الكمية المتاحة</th><th class="p-4">الكمية المقفلة</th><th class="p-4">القيمة التقديرية (USDT)</th></tr></thead><tbody id="assets-body"></tbody></table>
                    <div id="assets-loader" class="flex justify-center items-center p-8 hidden"><div class="loader"></div></div>
                    <p id="no-assets" class="text-center p-8 text-gray-500 hidden">لا توجد أصول لعرضها.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- *** SOLUTION: Embedded CryptoJS Library *** -->
    <script>
    var CryptoJS=CryptoJS||function(u,p){var d={},l=d.lib={},s=function(){},t=l.Base={extend:function(a){s.prototype=this;var c=new s;a&&c.mixIn(a);c.hasOwnProperty("init")||(c.init=function(){c.$super.init.apply(this,arguments)});c.init.prototype=c;c.$super=this;return c},create:function(){var a=this.extend();a.init.apply(a,arguments);return a},init:function(){},mixIn:function(a){for(var c in a)a.hasOwnProperty(c)&&(this[c]=a[c]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},r=l.WordArray=t.extend({init:function(a,c){a=this.words=a||[];this.sigBytes=c!=p?c:4*a.length},toString:function(a){return(a||v).stringify(this)},concat:function(a){var c=this.words,q=a.words,f=this.sigBytes;a=a.sigBytes;this.clamp();if(f%4)for(var b=0;b<a;b++)c[f+b>>>2]|=(q[b>>>2]>>>24-8*(b%4)&255)<<24-8*((f+b)%4);else if(65535<q.length)for(b=0;b<a;b+=4)c[f+b>>>2]=q[b>>>2];else c.push.apply(c,q);this.sigBytes+=a;return this},clamp:function(){var a=this.words,c=this.sigBytes;a[c>>>2]&=4294967295<<32-8*(c%4);a.length=u.ceil(c/4)},clone:function(){var a=t.clone.call(this);a.words=this.words.slice(0);return a},random:function(a){for(var c=[],q=0;q<a;q+=4)c.push(4294967296*u.random()|0);return new r.init(c,a)}}),w=d.enc={},v=w.Hex={stringify:function(a){var c=a.words;a=a.sigBytes;for(var q=[],f=0;f<a;f++){var b=c[f>>>2]>>>24-8*(f%4)&255;q.push((b>>>4).toString(16));q.push((b&15).toString(16))}return q.join("")},parse:function(a){for(var c=a.length,q=[],f=0;f<c;f+=2)q[f>>>3]|=parseInt(a.substr(f,2),16)<<24-4*(f%8);return new r.init(q,c/2)}},b=w.Latin1={stringify:function(a){var c=a.words;a=a.sigBytes;for(var q=[],f=0;f<a;f++)q.push(String.fromCharCode(c[f>>>2]>>>24-8*(f%4)&255));return q.join("")},parse:function(a){for(var c=a.length,q=[],f=0;f<c;f++)q[f>>>2]|=(a.charCodeAt(f)&255)<<24-8*(f%4);return new r.init(q,c)}},x=w.Utf8={stringify:function(a){try{return decodeURIComponent(escape(b.stringify(a)))}catch(c){throw Error("Malformed UTF-8 data")}},parse:function(a){return b.parse(unescape(encodeURIComponent(a)))}},g=l.BufferedBlockAlgorithm=t.extend({reset:function(){this._data=new r.init;this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=x.parse(a));this._data.concat(a);this._nDataBytes+=a.sigBytes},_process:function(a){var c=this._data,q=c.words,f=c.sigBytes,b=this.blockSize,d=f/(4*b),d=a?u.ceil(d):u.max((d|0)-this._minBufferSize,0);a=d*b;f=u.min(4*a,f);if(a){for(var g=0;g<a;g+=b)this._doProcessBlock(q,g);g=q.splice(0,a);c.sigBytes-=f}return new r.init(g,f)},clone:function(){var a=t.clone.call(this);a._data=this._data.clone();return a},_minBufferSize:0});l.Hasher=g.extend({cfg:t.extend(),init:function(a){this.cfg=this.cfg.extend(a);this.reset()},reset:function(){g.reset.call(this);this._doReset()},update:function(a){this._append(a);this._process();return this},finalize:function(a){a&&this._append(a);return this._doFinalize()},blockSize:16,_createHelper:function(a){return function(c,q){return(new a.init(q)).finalize(c)}},_createHmacHelper:function(a){return function(c,q){return(new k.HMAC.init(a,q)).finalize(c)}}});var k=d.algo={};return d}(Math);(function(){var u=CryptoJS,p=u.lib.WordArray;u.enc.Base64={stringify:function(d){var l=d.words,p=d.sigBytes,t=this._map;d.clamp();d=[];for(var r=0;r<p;r+=3)for(var w=(l[r>>>2]>>>24-8*(r%4)&255)<<16|(l[r+1>>>2]>>>24-8*((r+1)%4)&255)<<8|l[r+2>>>2]>>>24-8*((r+2)%4)&255,v=0;4>v&&r+0.75*v<p;v++)d.push(t.charAt(w>>>6*(3-v)&63));if(l=this._lookup)for(;d.length%4;)d.push(l);return d.join("")},parse:function(d){var l=d.length,s=this._map,t=this._lookup;if(!t){t=this._lookup=[];for(var r=0;64>r;r++)t[s.charAt(r).charCodeAt(0)]=r}s=t;p=new p.init;for(var w=0,v=0;v<l;v++)if(d.charCodeAt(v)in s){w|=s[d.charCodeAt(v)]<<18-6*(v%4);if(3==v%4){p.words[w>>>2]|=w<<24-8*((w>>>2)%4)&4294967295;w=0}}else if("="==d.charAt(v))break;return p},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}})();(function(u){function p(b,n,a,c,q,f,d){b=b+(n&a|~n&c)+q+d;return(b<<f|b>>>32-f)+n}function d(b,n,a,c,q,f,d){b=b+(n&c|a&~c)+q+d;return(b<<f|b>>>32-f)+n}function l(b,n,a,c,q,f,d){b=b+(n^a^c)+q+d;return(b<<f|b>>>32-f)+n}function s(b,n,a,c,q,f,d){b=b+(a^(n|~c))+q+d;return(b<<f|b>>>32-f)+n}for(var t=CryptoJS,r=t.lib,w=r.WordArray,v=r.Hasher,r=t.algo,b=[],x=0;64>x;x++)b[x]=4294967296*u.abs(u.sin(x+1))|0;r=r.MD5=v.extend({_doReset:function(){this._hash=new w.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(g,k){for(var a=0;16>a;a++){var c=k+a,q=g[c];g[c]=(q<<8|q>>>24)&16711935|(q<<24|q>>>8)&4278255360}var a=this._hash.words,c=g[k+0],q=g[k+1],f=g[k+2],h=g[k+3],m=g[k+4],e=g[k+5],j=g[k+6],i=g[k+7],o=g[k+8],n=g[k+9],T=g[k+10],U=g[k+11],V=g[k+12],W=g[k+13],X=g[k+14],Y=g[k+15],z=a[0],A=a[1],B=a[2],C=a[3],z=p(z,A,B,C,c,7,b[0]),C=p(C,z,A,B,q,12,b[1]),B=p(B,C,z,A,f,17,b[2]),A=p(A,B,C,z,h,22,b[3]),z=p(z,A,B,C,m,7,b[4]),C=p(C,z,A,B,e,12,b[5]),B=p(B,C,z,A,j,17,b[6]),A=p(A,B,C,z,i,22,b[7]),z=p(z,A,B,C,o,7,b[8]),C=p(C,z,A,B,n,12,b[9]),B=p(B,C,z,A,T,17,b[10]),A=p(A,B,C,z,U,22,b[11]),z=p(z,A,B,C,V,7,b[12]),C=p(C,z,A,B,W,12,b[13]),B=p(B,C,z,A,X,17,b[14]),A=p(A,B,C,z,Y,22,b[15]),z=d(z,A,B,C,q,5,b[16]),C=d(C,z,A,B,j,9,b[17]),B=d(B,C,z,A,U,14,b[18]),A=d(A,B,C,z,c,20,b[19]),z=d(z,A,B,C,e,5,b[20]),C=d(C,z,A,B,T,9,b[21]),B=d(B,C,z,A,Y,14,b[22]),A=d(A,B,C,z,m,20,b[23]),z=d(z,A,B,C,n,5,b[24]),C=d(C,z,A,B,X,9,b[25]),B=d(B,C,z,A,h,14,b[26]),A=d(A,B,C,z,o,20,b[27]),z=d(z,A,B,C,W,5,b[28]),C=d(C,z,A,B,f,9,b[29]),B=d(B,C,z,A,i,14,b[30]),A=d(A,B,C,z,V,20,b[31]),z=l(z,A,B,C,e,4,b[32]),C=l(C,z,A,B,o,11,b[33]),B=l(B,C,z,A,U,16,b[34]),A=l(A,B,C,z,X,23,b[35]),z=l(z,A,B,C,q,4,b[36]),C=l(C,z,A,B,m,11,b[37]),B=l(B,C,z,A,i,16,b[38]),A=l(A,B,C,z,T,23,b[39]),z=l(z,A,B,C,W,4,b[40]),C=l(C,z,A,B,c,11,b[41]),B=l(B,C,z,A,h,16,b[42]),A=l(A,B,C,z,j,23,b[43]),z=l(z,A,B,C,n,4,b[44]),C=l(C,z,A,B,V,11,b[45]),B=l(B,C,z,A,Y,16,b[46]),A=l(A,B,C,z,f,23,b[47]),z=s(z,A,B,C,c,6,b[48]),C=s(C,z,A,B,i,10,b[49]),B=s(B,C,z,A,X,15,b[50]),A=s(A,B,C,z,e,21,b[51]),z=s(z,A,B,C,V,6,b[52]),C=s(C,z,A,B,h,10,b[53]),B=s(B,C,z,A,T,15,b[54]),A=s(A,B,C,z,q,21,b[55]),z=s(z,A,B,C,o,6,b[56]),C=s(C,z,A,B,Y,10,b[57]),B=s(B,C,z,A,j,15,b[58]),A=s(A,B,C,z,W,21,b[59]),z=s(z,A,B,C,m,6,b[60]),C=s(C,z,A,B,f,10,b[61]),B=s(B,C,z,A,n,15,b[62]),A=s(A,B,C,z,U,21,b[63]);a[0]=a[0]+z|0;a[1]=a[1]+A|0;a[2]=a[2]+B|0;a[3]=a[3]+C|0},_doFinalize:function(){var b=this._data,n=b.words,a=8*this._nDataBytes,c=8*b.sigBytes;n[c>>>5]|=128<<24-c%32;var q=u.floor(a/4294967296);n[(c+64>>>9<<4)+15]=((q<<8|q>>>24)&16711935|(q<<24|q>>>8)&4278255360);n[(c+64>>>9<<4)+14]=((a<<8|a>>>24)&16711935|(a<<24|a>>>8)&4278255360);b.sigBytes=4*(n.length+1);this._process();b=this._hash;n=b.words;for(a=0;4>a;a++)c=n[a],n[a]=((c<<8|c>>>24)&16711935|(c<<24|c>>>8)&4278255360);return b},clone:function(){var b=v.clone.call(this);b._hash=this._hash.clone();return b}});t.MD5=v._createHelper(r);t.HmacMD5=v._createHmacHelper(r)})(Math);(function(){var u=CryptoJS,p=u.lib,d=p.Base,l=p.WordArray,p=u.algo,s=p.EvpKDF=d.extend({cfg:d.extend({keySize:4,hasher:p.MD5,iterations:1}),init:function(t){this.cfg=this.cfg.extend(t)},compute:function(t,r){for(var d=this.cfg,v=d.hasher.create(),b=l.create(),x=b.words,g=d.keySize,k=d.iterations;x.length<g;){a&&v.update(a);var a=v.update(t).finalize(r);v.reset();for(var c=1;c<k;c++)a=v.finalize(a),v.reset();b.concat(a)}b.sigBytes=4*g;return b}});u.EvpKDF=function(t,r,d){return s.create(d).compute(t,r)}})();CryptoJS.lib.Cipher||function(u){var p=CryptoJS,d=p.lib,l=d.Base,s=d.WordArray,t=d.BufferedBlockAlgorithm,r=p.enc.Base64,w=p.algo.EvpKDF,v=d.Cipher=t.extend({cfg:l.extend(),createEncryptor:function(e,a){return this.create(this._ENC_XFORM_MODE,e,a)},createDecryptor:function(e,a){return this.create(this._DEC_XFORM_MODE,e,a)},init:function(e,a,c){this.cfg=this.cfg.extend(c);this._xformMode=e;this._key=a;this.reset()},reset:function(){t.reset.call(this);this._doReset()},process:function(e){this._append(e);return this._process()},finalize:function(e){e&&this._append(e);return this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(e){return{encrypt:function(a,c,q){return("string"==typeof c?k:g).encrypt(e,a,c,q)},decrypt:function(a,c,q){return("string"==typeof c?k:g).decrypt(e,a,c,q)}}}});d.StreamCipher=v.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var b=p.mode={},x=function(e,a,c){var q=this._iv;q?this._iv=u:q=this._prevBlock;for(var f=0;f<c;f++)e[a+f]^=q[f]},g=(d.BlockCipherMode=l.extend({createEncryptor:function(e,a){return this.Encryptor.create(e,a)},createDecryptor:function(e,a){return this.Decryptor.create(e,a)},init:function(e,a){this._cipher=e;this._iv=a}})).extend();g.Encryptor=g.extend({processBlock:function(e,a){var c=this._cipher,q=c.blockSize;x.call(this,e,a,q);c.encryptBlock(e,a);this._prevBlock=e.slice(a,a+q)}});g.Decryptor=g.extend({processBlock:function(e,a){var c=this._cipher,q=c.blockSize,f=e.slice(a,a+q);c.decryptBlock(e,a);x.call(this,e,a,q);this._prevBlock=f}});b=b.CBC=g;g=(p.pad={}).Pkcs7={pad:function(e,a){for(var c=4*a,c=c-e.sigBytes%c,q=c<<24|c<<16|c<<8|c,f=[],b=0;b<c;b+=4)f.push(q);e.concat(s.create(f,c))},unpad:function(e){e.sigBytes-=e.words[e.sigBytes-1>>>2]&255}};d.BlockCipher=v.extend({cfg:v.cfg.extend({mode:b,padding:g}),reset:function(){v.reset.call(this);var e=this.cfg,a=e.iv,e=e.mode;if(this._xformMode==this._ENC_XFORM_MODE)var c=e.createEncryptor;else c=e.createDecryptor,this._minBufferSize=1;this._mode=c.call(e,this,a&&a.words)},_doProcessBlock:function(e,a){this._mode.processBlock(e,a)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var a=this._process(!0)}else a=this._process(!0),e.unpad(a);return a},blockSize:4});var k=d.SerializableCipher=l.extend({cfg:l.extend({format:r}),encrypt:function(e,a,c,q){q=this.cfg.extend(q);var f=e.createEncryptor(c,q);a=f.finalize(a);f=f.cfg;return l.create({ciphertext:a,key:c,iv:f.iv,algorithm:e,mode:f.mode,padding:f.padding,blockSize:e.blockSize,formatter:q.format})},decrypt:function(e,a,c,q){q=this.cfg.extend(q);a="string"==typeof a?q.format.parse(a):a;return e.createDecryptor(c,q).finalize(a.ciphertext)},_parse:function(e,a){return"string"==typeof e?a.parse(e,this):e}}),p=(p.kdf={}).OpenSSL={execute:function(e,a,c,q){q||(q=s.random(8));e=w.create({keySize:a+c}).compute(e,q);c=s.create(e.words.slice(a),4*c);e.sigBytes=4*a;return l.create({key:e,iv:c,salt:q})}},g=d.PasswordBasedCipher=k.extend({cfg:k.cfg.extend({kdf:p}),encrypt:function(e,a,c,q){q=this.cfg.extend(q);c=q.kdf.execute(c,e.keySize,e.ivSize);q.iv=c.iv;e=k.encrypt.call(this,e,a,c.key,q);e.mixIn(c);return e},decrypt:function(e,a,c,q){q=this.cfg.extend(q);a="string"==typeof a?q.format.parse(a):a;c=q.kdf.execute(c,e.keySize,e.ivSize,a.salt);q.iv=c.iv;return k.decrypt.call(this,e,a,c.key,q)}})}();(function(){for(var u=CryptoJS,p=u.lib.BlockCipher,d=u.algo,l=[],s=[],t=[],r=[],w=[],v=[],b=[],x=[],g=[],k=[],a=[],c=0;256>c;c++)a[c]=128>c?c<<1:c<<1^283;for(var q=0,f=0,c=0;256>c;c++){var h=f^f<<1^f<<2^f<<3^f<<4,h=h>>8^h&255^99;q^=h<<0;f^=h<<1;var m=q^q<<1^q<<2^q<<3^q<<4,m=m>>8^m&255^99,e=a[q],j=a[e],i=a[j];h=257*h^16843008*q;l[q]=h<<24|h>>>8;s[q]=h<<16|h>>>16;t[q]=h<<8|h>>>24;r[q]=h;h=16843009*m^65537*j^257*i^16843008*e;w[e]=h<<24|h>>>8;v[e]=h<<16|h>>>16;b[e]=h<<8|h>>>24;x[e]=h;0==q?(q=f=1):c==161?(q=228,f=136):c==223&&(q=132,f=72)}d=d.AES=p.extend({_doReset:function(){for(var c=this._key,q=c.words,f=c.sigBytes/4,c=4*((this._nRounds=f+6)+1),h=this._keySchedule=[],m=0;m<c;m++)if(m<f)h[m]=q[m];else{var e=h[m-1];m%f?6<f&&4==m%f&&(e=l[e>>>24]<<24|s[e>>>16&255]<<16|t[e>>>8&255]<<8|r[e&255]):(e=e<<8|e>>>24,e=l[e>>>24]<<24|s[e>>>16&255]<<16|t[e>>>8&255]<<8|r[e&255],e^=g[m/f|0]<<24);h[m]=h[m-f]^e}q=this._invKeySchedule=[];for(f=0;f<c;f++)m=c-f,e=f%4?h[m]:h[m-4],q[f]=4>f||4>=m?e:w[l[e>>>24]]^v[s[e>>>16&255]]^b[t[e>>>8&255]]^x[r[e&255]]},encryptBlock:function(c,q){this._doCryptBlock(c,q,this._keySchedule,l,s,t,r,g)},decryptBlock:function(c,q){var f=c[q+1];c[q+1]=c[q+3];c[q+3]=f;this._doCryptBlock(c,q,this._invKeySchedule,w,v,b,x,k);f=c[q+1];c[q+1]=c[q+3];c[q+3]=f},_doCryptBlock:function(c,q,f,h,m,e,j,i){for(var o=this._nRounds,n=c[q]^f[0],l=c[q+1]^f[1],a=c[q+2]^f[2],s=c[q+3]^f[3],p=4,d=1;d<o;d++){var r=h[n>>>24]^m[l>>>16&255]^e[a>>>8&255]^j[s&255]^f[p++],g=h[l>>>24]^m[a>>>16&255]^e[s>>>8&255]^j[n&255]^f[p++],b=h[a>>>24]^m[s>>>16&255]^e[n>>>8&255]^j[l&255]^f[p++],s=h[s>>>24]^m[n>>>16&255]^e[l>>>8&255]^j[a&255]^f[p++],n=r,l=g,a=b}r=(h[n>>>24]<<24|s[l>>>16&255]<<16|t[a>>>8&255]<<8|r[s&255])^f[p++];g=(h[l>>>24]<<24|s[a>>>16&255]<<16|t[s>>>8&255]<<8|r[n&255])^f[p++];b=(h[a>>>24]<<24|s[s>>>16&255]<<16|t[n>>>8&255]<<8|r[l&255])^f[p++];s=(h[s>>>24]<<24|s[n>>>16&255]<<16|t[l>>>8&255]<<8|r[a&255])^f[p++];c[q]=r;c[q+1]=g;c[q+2]=b;c[q+3]=s},keySize:8});u.AES=p._createHelper(d)})();(function(){var u=CryptoJS,p=u.lib,d=p.WordArray,l=p.algo,s=l.MD5,t=l.SHA1=function(u){var p=u.lib,d=p.WordArray,l=p.Hasher,s=u.algo,t=[],r=s.SHA1=l.extend({_doReset:function(){this._hash=new d.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(d,v){for(var b=this._hash.words,x=b[0],g=b[1],k=b[2],a=b[3],c=b[4],q=0;80>q;q++){if(16>q)t[q]=d[v+q]|0;else{var f=t[q-3]^t[q-8]^t[q-14]^t[q-16];t[q]=f<<1|f>>>31}f=(x<<5|x>>>27)+c+t[q];f=20>q?f+((g&k|~g&a)+1518500249):40>q?f+((g^k^a)+1859775393):60>q?f+((g&k|g&a|k&a)-1894007588):f+((g^k^a)-899497514);c=a;a=k;k=g<<30|g>>>2;g=x;x=f}b[0]=b[0]+x|0;b[1]=b[1]+g|0;b[2]=b[2]+k|0;b[3] =b[3]+a|0;b[4]=b[4]+c|0},_doFinalize:function(){var d=this._data,l=d.words,p=8*this._nDataBytes,s=8*d.sigBytes;l[s>>>5]|=128<<24-s%32;l[(s+64>>>9<<4)+15]=Math.floor(p/4294967296);l[(s+64>>>9<<4)+14]=p;d.sigBytes=4*(l.length+1);this._process();return this._hash},clone:function(){var d=l.clone.call(this);d._hash=this._hash.clone();return d}});u.SHA1=l._createHelper(r);u.HmacSHA1=l._createHmacHelper(r)}();(function(){var u=CryptoJS,p=u.lib,d=p.Base,l=p.WordArray,s=u.algo,t=s.SHA256=function(u){var p=u.lib,d=p.WordArray,l=p.Hasher,s=[],t=[],r=function(d){return 4294967296*d|0},w=s.SHA256=l.extend({_doReset:function(){this._hash=new d.init([r(0.53125),r(0.98828125),r(0.1953125),r(0.68359375),r(0.55078125),r(0.40625),r(0.0703125),r(0.51171875)])},_doProcessBlock:function(d,p){for(var b=this._hash.words,x=b[0],g=b[1],k=b[2],a=b[3],c=b[4],q=b[5],f=b[6],h=b[7],m=0;64>m;m++){if(16>m)t[m]=d[p+m]|0;else{var e=t[m-15],j=t[m-2];t[m]=((e>>>7|e<<25)^(e>>>18|e<<14)^e>>>3)+t[m-7]+((j>>>17|j<<15)^(j>>>19|j<<13)^j>>>10)+t[m-16]}e=h+((c>>>6|c<<26)^(c>>>11|c<<21)^(c>>>25|c<<7))+(c&q^~c&f)+s[m]+t[m];j=((x>>>2|x<<30)^(x>>>13|x<<19)^(x>>>22|x<<10))+(x&g^x&k^g&k);h=f;f=q;q=c;c=a+e|0;a=k;k=g;g=x;x=e+j|0}b[0]=b[0]+x|0;b[1]=b[1]+g|0;b[2]=b[2]+k|0;b[3]=b[3]+a|0;b[4]=b[4]+c|0;b[5]=b[5]+q|0;b[6]=b[6]+f|0;b[7]=b[7]+h|0},_doFinalize:function(){var d=this._data,p=d.words,b=8*this._nDataBytes,l=8*d.sigBytes;p[l>>>5]|=128<<24-l%32;p[(l+64>>>9<<4)+15]=b;d.sigBytes=4*p.length;this._process();return this._hash},clone:function(){var d=l.clone.call(this);d._hash=this._hash.clone();return d}});u.SHA256=l._createHelper(w);u.HmacSHA256=l._createHmacHelper(w)}();(function(){var u=CryptoJS,p=u.lib,d=p.Base,l=p.WordArray,s=u.algo,t=s.HMAC=d.extend({init:function(d,w){d=this._hasher=new d.init;"string"==typeof w&&(w=u.enc.Utf8.parse(w));var v=d.blockSize,b=4*v;w.sigBytes>b&&(w=d.finalize(w));w.clamp();for(var x=this._oKey=w.clone(),g=this._iKey=w.clone(),k=x.words,a=g.words,c=0;c<v;c++)k[c]^=1549556828,a[c]^=909522486;x.sigBytes=g.sigBytes=b;this.reset()},reset:function(){var d=this._hasher;d.reset();d.update(this._iKey)},update:function(d){this._hasher.update(d);return this},finalize:function(d){var u=this._hasher;d=u.finalize(d);u.reset();return u.finalize(this._oKey.clone().concat(d))}})})();
    </script>
    
    <!-- Main Application Logic -->
    <script>
        const API_BASE_URL = 'https://api.mexc.com';
        const UI = {
            apiKeyInput: document.getElementById('apiKey'),
            secretKeyInput: document.getElementById('secretKey'),
            connectBtn: document.getElementById('connect-btn'),
            disconnectBtn: document.getElementById('disconnect-btn'),
            errorMessage: document.getElementById('error-message'),
            apiSection: document.getElementById('api-section'),
            dashboardSection: document.getElementById('dashboard-section'),
            totalBalanceElem: document.getElementById('total-balance'),
            assetsValueElem: document.getElementById('assets-value'),
            assetsCountElem: document.getElementById('assets-count'),
            assetsBody: document.getElementById('assets-body'),
            assetsLoader: document.getElementById('assets-loader'),
            noAssetsMsg: document.getElementById('no-assets'),
        };

        window.addEventListener('load', () => {
            const savedApiKey = localStorage.getItem('mexcApiKey');
            const savedSecretKey = localStorage.getItem('mexcSecretKey');
            if (savedApiKey && savedSecretKey) {
                UI.apiKeyInput.value = savedApiKey;
                UI.secretKeyInput.value = savedSecretKey;
                connectAndFetchData();
            }
        });

        UI.connectBtn.addEventListener('click', () => {
             const apiKey = UI.apiKeyInput.value.trim();
             const secretKey = UI.secretKeyInput.value.trim();
             if (!apiKey || !secretKey) {
                 showError('يرجى إدخال مفتاح الوصول والمفتاح السري.');
                 return;
             }
             localStorage.setItem('mexcApiKey', apiKey);
             localStorage.setItem('mexcSecretKey', secretKey);
             connectAndFetchData();
        });

        UI.disconnectBtn.addEventListener('click', () => {
            localStorage.removeItem('mexcApiKey');
            localStorage.removeItem('mexcSecretKey');
            UI.apiKeyInput.value = '';
            UI.secretKeyInput.value = '';
            showDashboard(false);
        });

        function showError(message) {
            UI.errorMessage.innerHTML = `<strong>خطأ:</strong> ${message}`;
            UI.errorMessage.classList.remove('hidden');
        }

        function hideError() {
            UI.errorMessage.classList.add('hidden');
        }

        function showDashboard(show) {
            UI.dashboardSection.classList.toggle('hidden', !show);
            UI.apiSection.classList.toggle('hidden', show);
        }

        function toggleLoaders(show) {
            UI.assetsLoader.classList.toggle('hidden', !show);
            UI.noAssetsMsg.classList.add('hidden');
            if(show) UI.assetsBody.innerHTML = '';
        }

        async function connectAndFetchData() {
            hideError();
            showDashboard(true);
            toggleLoaders(true);

            try {
                const accountInfo = await makeRequest('/api/v3/account');
                const assets = accountInfo.balances.filter(b => (parseFloat(b.free) + parseFloat(b.locked)) > 0.00001);
                
                const symbols = assets.filter(a => a.asset !== 'USDT').map(a => `${a.asset}USDT`);
                const prices = await fetchCurrentPrices(symbols);

                updateDashboard(accountInfo, assets, prices);

            } catch (error) {
                console.error('Error fetching data:', error);
                showError(`فشل في جلب البيانات. <br>السبب من الخادم: "${error.message}" <br><br>يرجى التأكد من صلاحيات مفتاح API (قراءة فقط) وإعدادات IP.`);
                showDashboard(false);
            } finally {
                toggleLoaders(false);
            }
        }
        
        async function makeRequest(endpoint, params = {}) {
            const apiKey = localStorage.getItem('mexcApiKey');
            const secretKey = localStorage.getItem('mexcSecretKey');
            if (!apiKey || !secretKey) throw new Error("API keys not found.");

            const timestamp = Date.now();
            const recvWindow = 5000;
            const queryString = new URLSearchParams({...params, timestamp, recvWindow}).toString();
            
            // This will now work because CryptoJS is embedded in the page
            const signature = CryptoJS.HmacSHA256(queryString, secretKey).toString(CryptoJS.enc.Hex);
            const url = `${API_BASE_URL}${endpoint}?${queryString}&signature=${signature}`;

            const response = await fetch(url, {
                method: 'GET',
                headers: { 'X-MEXC-APIKEY': apiKey, 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.msg || `HTTP Error ${response.status}`);
            }
            return response.json();
        }
        
        async function fetchCurrentPrices(symbols) {
            if (symbols.length === 0) return {};
            const url = `${API_BASE_URL}/api/v3/ticker/price`;
            try {
                const response = await fetch(url);
                if (!response.ok) return {};
                const allPrices = await response.json();
                const prices = {};
                allPrices.forEach(item => {
                    if (symbols.includes(item.symbol)) {
                        prices[item.symbol] = parseFloat(item.price);
                    }
                });
                return prices;
            } catch (error) {
                console.error("Could not fetch prices:", error);
                return {};
            }
        }

        function updateDashboard(accountInfo, assets, prices) {
            UI.assetsBody.innerHTML = '';
            let totalAssetsValue = 0;

            const usdtAsset = assets.find(a => a.asset === 'USDT');
            const usdtValue = usdtAsset ? (parseFloat(usdtAsset.free) + parseFloat(usdtAsset.locked)) : 0;
            
            const otherAssets = assets.filter(a => a.asset !== 'USDT');
            UI.assetsCountElem.textContent = otherAssets.length;

            if (assets.length === 0) {
                UI.noAssetsMsg.classList.remove('hidden');
            } else {
                 assets.forEach(asset => {
                    const totalAmount = parseFloat(asset.free) + parseFloat(asset.locked);
                    const symbol = `${asset.asset}USDT`;
                    const currentPrice = prices[symbol] || (asset.asset === 'USDT' ? 1 : 0);
                    const value = totalAmount * currentPrice;
                    totalAssetsValue += value;

                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700 hover:bg-gray-800';
                    row.innerHTML = `
                        <td class="p-4 font-medium text-white">${asset.asset}</td>
                        <td class="p-4">${parseFloat(asset.free).toFixed(6)}</td>
                        <td class="p-4">${parseFloat(asset.locked).toFixed(6)}</td>
                        <td class="p-4 font-bold text-white">${value.toFixed(2)}</td>
                    `;
                    UI.assetsBody.appendChild(row);
                });
            }

            UI.totalBalanceElem.textContent = (totalAssetsValue).toFixed(2);
            UI.assetsValueElem.textContent = (totalAssetsValue - usdtValue).toFixed(2);
        }
    </script>
</body>
</html>
